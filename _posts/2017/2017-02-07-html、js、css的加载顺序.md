---
layout: mypost
title: html、js、css的加载顺序
categories: [html]
---

### HTML页面加载和解析流程
1. 用户输入网址（假设是个html页面，并且是第一次访问），浏览器向服务器发出请求，服务器返回html文件。

2. 浏览器开始载入html代码，发现\<head\>标签内有一个\<link\>标签引用外部CSS文件。

3. 浏览器又发出CSS文件的请求，服务器返回这个CSS文件。

4. 浏览器继续载入html中\<body\>部分的代码，并且CSS文件已经拿到手了，可以开始渲染页面了。

5. 浏览器在代码中发现一个\<img\>标签引用了一张图片，向服务器发出请求。此时浏览器不会等到图片下载完，而是继续渲染后面的代码。

6. 服务器返回图片文件，由于图片占用了一定面积，影响了后面段落的排布，因此浏览器需要回过头来重新渲染这部分代码。

7. 浏览器发现了一个包含一行Javascript代码的\<script\>标签，赶快运行它。

8. Javascript脚本执行了这条语句，它命令浏览器隐藏掉代码中的某个\<style\>（style.display="none"）。杯具啊，突然就少了这么一个元素，浏览器不得不重新渲染这部分代码。

9. 终于等到了\<\/html\>的到来，浏览器泪流满面……

10. 等等，还没完，用户点了一下界面中的"换肤"按钮，Javascript让浏览器换了一下\＜link\＞标签的CSS路径。

11. 浏览器召集了在座的各位\<div\>\<span\>\<ul\>\<li\>们，“大伙儿收拾收拾行李，咱得重新来过……”，浏览器向服务器请求了新的CSS文件，重新渲染页面。


总结：

1. 总的来说就是按照html文档的顺序加载

2. 还有就是最好将无论内部或是外部JS文件放到所有html内容之后，这样会令用户感觉页面加载速度变快了，否则如果将所有外部文件（包括css和JS）引用都放到\<head\>中，意味着必须等到全部的JS代码都被下载解析和执行完毕后，才能开始呈现页面的内容（当浏览器遇到\<body\>）,这样会导致呈现页面时出现明显的延迟，延迟期间的浏览器窗口将是一片空白。


### HTML页面加载和解析流程，版本二
js放在head中会立即执行，阻塞后续的资源下载与执行。因为js有可能会修改dom，如果不阻塞后续的资源下载，dom的操作顺序不可控。

正常的网页加载流程是这样的：

1. 浏览器一边下载HTML网页，一边开始解析

2. 解析过程中，发现\<script\>标签

3. 暂停解析，网页渲染的控制权转交给JavaScript引擎

4. 如果\<script\>标签引用了外部脚本，就下载该脚本，否则就直接执行

5. 执行完毕，控制权交还渲染引擎，恢复往下解析HTML网页

如果外部脚本加载时间很长（比如一直无法完成下载），就会造成网页长时间失去响应，浏览器就会呈现“假死”状态，这被称为“阻塞效应”。html需要等head中所有的js和css加载完成后才会开始绘制，但是html不需要等待放在body最后的js下载执行就会开始绘制,因此将js放在body的最后面，可以避免资源阻塞，同时使静态的html页面迅速显示。将脚本文件都放在网页尾部加载，还有一个好处。在DOM结构生成之前就调用DOM，JavaScript会报错，如果脚本都在网页尾部加载，就不存在这个问题，因为这时DOM肯定已经生成了。


### js、css执行顺序
#### css
css需要分块，首页的css独立，其余的css需要动态加载，因为html的绘制会被css阻塞，这样可以减少首次进入时的白屏时间。

#### js
*js的执行依赖前面的样式。即只有前面的样式全部下载完成后才会执行js，但是此时外链css和外链js是并行下载的。（js和css解析到后就会开始下载，不会等前面的js/css下载完才开始下载，所以也有可能后开始下载的较小的js/css先下载完成，不过运行顺序还是按照书写顺序，下载完如果前面还没运行也不会运行）*

**defer**

外链的js如果含有defer="true"属性，将会并行加载js，到页面全部加载完成后才会执行，会按顺序执行。

defer属性的作用是，告诉浏览器，等到DOM加载完成后，再执行指定脚本。

1. 浏览器开始解析HTML网页

2. 解析过程中，发现带有defer属性的script标签

3. 浏览器继续往下解析HTML网页，同时并行下载script标签中的外部脚本

4. 浏览器完成解析HTML网页，此时再执行下载的脚本

*对于内置而不是连接外部脚本的script标签，以及动态生成的script标签，defer属性不起作用。*

**async**

外链的js如果含有async="true"属性，将不会依赖于任何js和css的执行，此js下载完成后立刻执行，不保证按照书写的顺序执行。因为async="true"属性会告诉浏览器，js不会修改dom和样式，故不必依赖其它的js和css。　

async属性的作用是，使用另一个进程下载脚本，下载时不会阻塞渲染。

1. 浏览器开始解析HTML网页

2. 解析过程中，发现带有async属性的script标签

3. 浏览器继续往下解析HTML网页，同时并行下载script标签中的外部脚本

4. 脚本下载完成，浏览器暂停解析HTML网页，开始执行下载的脚本

5. 脚本执行完毕，浏览器恢复解析HTML网页

*async属性可以保证脚本下载的同时，浏览器继续渲染。需要注意的是，一旦采用这个属性，就无法保证脚本的执行顺序。哪个脚本先下载结束，就先执行那个脚本。另外，使用async属性的脚本文件中，不应该使用document.write方法。*

一般来说，如果脚本之间没有依赖关系，就使用async属性，如果脚本之间有依赖关系，就使用defer属性。如果同时使用async和defer属性，后者不起作用，浏览器行为由async属性决定。
